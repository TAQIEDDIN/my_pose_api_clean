<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Posture Analysis</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #e8e8e8;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header {
            background: white; padding: 20px 30px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px;
        }
        h1 { color: #667eea; font-size: 28px; margin-bottom: 5px; }
        .subtitle { color: #666; font-size: 14px; }
        
        /* Stats Grid */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; padding: 25px; border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card h3 { color: #888; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; }
        .stat-card .number { color: #667eea; font-size: 36px; font-weight: bold; }

        /* Poses Section */
        .poses-section {
            background: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 15px;
        }
        .header-controls { display: flex; gap: 15px; align-items: center; }
        .user-filter { display: flex; align-items: center; gap: 10px; }
        .user-filter select {
            padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;
        }
        .refresh-btn {
            background: #667eea; color: white; border: none; padding: 10px 20px;
            border-radius: 8px; cursor: pointer;
        }
        .refresh-btn:hover { background: #5568d3; }

        /* Table */
        .poses-table { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px; text-align: left; font-weight: 600; color: #333; border-bottom: 2px solid #dee2e6; }
        td { padding: 15px; border-bottom: 1px solid #dee2e6; }
        tr:hover { background: #f8f9fa; }
        .badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        
        .btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-right: 5px; }
        .btn-view { background: #667eea; color: white; }
        .btn-delete { background: #dc3545; color: white; }

        /* Pagination */
        .pagination {
            display: flex; justify-content: center; gap: 10px; margin-top: 30px; align-items: center;
        }
        .pagination button, .pagination span {
            padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px;
            cursor: pointer; background: white; transition: all 0.3s;
        }
        .pagination button:hover { background: #667eea; color: white; border-color: #667eea; }
        .pagination .active { background: #667eea; color: white; border-color: #667eea; }
        .pagination .disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination .page-info { margin: 0 15px; color: #666; font-size: 14px; }

        /* Modal */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); overflow: auto;
        }
        .modal-content {
            background-color: white; margin: 2% auto; padding: 0;
            width: 90%; max-width: 1200px; border-radius: 15px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px 30px; border-radius: 15px 15px 0 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .close { color: white; font-size: 35px; font-weight: bold; cursor: pointer; }
        .modal-body { padding: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        
        .image-section { display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; border-radius: 10px; padding: 10px; min-height: 400px; }
        
        #poseCanvas {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
        }

        .details-section { display: flex; flex-direction: column; gap: 20px; }
        .detail-card { background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #dee2e6; padding-bottom: 8px; }
        .detail-value { font-weight: bold; color: #333; }

        @media (max-width: 768px) {
            .modal-body { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    
    <div class="container">
        <header>
            <h1>Admin Dashboard</h1>
            <p class="subtitle">Posture Analysis System - Real-time Monitoring</p>
        </header>

        <div class="stats-grid">
            <div class="stat-card"><h3>üë• Total Users</h3><div class="number" id="totalUsers">-</div></div>
            <div class="stat-card"><h3>üì∏ Total Poses</h3><div class="number" id="totalPoses">-</div></div>
            <div class="stat-card"><h3>üìä Today's Uploads</h3><div class="number" id="todayUploads">-</div></div>
            <div class="stat-card"><h3>‚ö° System Status</h3><div class="number" style="color: #28a745;">‚óè ACTIVE</div></div>
        </div>

        <div class="poses-section">
            <div style="text-align: right; margin-bottom: 20px;">
                <button class="btn btn-view" onclick="window.location.href='/admin/user_sessions'" style="font-size: 14px; padding: 10px 20px;">
                    üìà Compare Sessions
                </button>
            </div>

            <div class="section-header">
                <h2>üìã All User Poses</h2>
                <div class="header-controls">
                    <div class="user-filter">
                        <label>Filter:</label>
                        <select id="userSelect" onchange="filterByUser()"><option value="all">All Users</option></select>
                    </div>
                    <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
                </div>
            </div>

            <div id="loadingState" class="loading"><p>‚è≥ Loading data...</p></div>
            
            <div id="posesTable" style="display: none;">
                <div class="poses-table">
                    <table>
                        <thead>
                            <tr><th>User</th><th>Timestamp</th><th>Shoulder Diff</th><th>Hip Diff</th><th>Status</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="posesTableBody"></tbody>
                    </table>
                </div>
                <div class="pagination" id="paginationControls"></div>
            </div>
            <div id="emptyState" class="empty-state" style="display: none;"><p>üì≠ No Poses Found</p></div>
        </div>
    </div>

    <div id="poseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì∏ Pose Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="image-section">
                    <canvas id="poseCanvas"></canvas>
                    <p id="imageStatus" style="color: #ccc; display: none;">Loading image...</p>
                </div>
                <div class="details-section">
                    <div class="detail-card">
                        <h3>üë§ User Info</h3>
                        <div class="detail-row"><span>Name:</span><span class="detail-value" id="modalUserName">-</span></div>
                        <div class="detail-row"><span>Email:</span><span class="detail-value" id="modalUserEmail">-</span></div>
                        <div class="detail-row"><span>Time:</span><span class="detail-value" id="modalTimestamp">-</span></div>
                    </div>
                    <div class="detail-card">
                        <h3>üìä Results</h3>
                        <div class="detail-row"><span>Shoulder Diff:</span><span class="detail-value" id="modalShoulder">-</span></div>
                        <div class="detail-row"><span>Hip Diff:</span><span class="detail-value" id="modalHip">-</span></div>
                        <div class="detail-row"><span>Higher Shoulder:</span><span class="detail-value" id="modalShoulderSide">-</span></div>
                        <div class="detail-row"><span>Higher Hip:</span><span class="detail-value" id="modalHipSide">-</span></div>
                        <div class="detail-row"><span>Status:</span><span class="detail-value" id="modalStatus">-</span></div>
                    </div>
                    <div class="detail-card" style="background:#fff3cd; border-left-color:#ffc107;">
                        <h3>üí¨ Comment</h3>
                        <p id="modalComment">-</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let allPoses = [];
        let filteredPoses = [];
        let currentPage = 1;
        const itemsPerPage = 6;

        const SKELETON_CONNECTIONS = [
            ['leftShoulder', 'rightShoulder'],
            ['leftShoulder', 'leftElbow'], ['leftElbow', 'leftWrist'],
            ['rightShoulder', 'rightElbow'], ['rightElbow', 'rightWrist'],
            ['leftShoulder', 'leftHip'], ['rightShoulder', 'rightHip'],
            ['leftHip', 'rightHip'],
            ['leftHip', 'leftKnee'], ['leftKnee', 'leftAnkle'],
            ['rightHip', 'rightKnee'], ['rightKnee', 'rightAnkle']
        ];

        async function loadData() {
            try {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('posesTable').style.display = 'none';
                
                const statsResponse = await fetch('/admin/stats');
                const stats = await statsResponse.json();
                document.getElementById('totalUsers').textContent = stats.total_users || 0;
                document.getElementById('totalPoses').textContent = stats.total_poses || 0;
                document.getElementById('todayUploads').textContent = stats.today_uploads || 0;
                
                const posesResponse = await fetch('/admin/get-all-poses');
                const posesData = await posesResponse.json();
                
                document.getElementById('loadingState').style.display = 'none';
                
                if (posesData.success) {
                    allPoses = posesData.poses;
                    populateUserSelect();
                    currentPage = 1;
                    filterByUser();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function populateUserSelect() {
            const select = document.getElementById('userSelect');
            select.innerHTML = '<option value="all">All Users</option>';
            const uniqueUsers = [...new Set(allPoses.map(p => p.user_id))];
            uniqueUsers.forEach(id => {
                const user = allPoses.find(p => p.user_id === id);
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = user.user_name || 'Unknown';
                select.appendChild(opt);
            });
        }

        function filterByUser() {
            const userId = document.getElementById('userSelect').value;
            filteredPoses = userId === 'all' ? allPoses : allPoses.filter(p => p.user_id === userId);
            currentPage = 1;
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('posesTableBody');
            tbody.innerHTML = '';
            
            if (filteredPoses.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('posesTable').style.display = 'none';
                return;
            }

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('posesTable').style.display = 'block';

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredPoses.slice(start, end);

            pageData.forEach(pose => {
                const sDiff = Math.abs(pose.shoulder_y_diff || 0).toFixed(2);
                const hDiff = Math.abs(pose.hip_y_diff || 0).toFixed(2);
                let badge = '<span class="badge badge-success">Normal</span>';
                if (sDiff > 10 || hDiff > 10) badge = '<span class="badge badge-danger">High Risk</span>';
                else if (sDiff > 5 || hDiff > 5) badge = '<span class="badge badge-warning">Moderate</span>';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="user-info">
                            <span class="user-name">${pose.user_name || 'Unknown'}</span>
                            <span class="user-email">${pose.user_email || '-'}</span>
                        </div>
                    </td>
                    <td>${new Date(pose.timestamp).toLocaleString()}</td>
                    <td>${sDiff} mm</td>
                    <td>${hDiff} mm</td>
                    <td>${badge}</td>
                    <td>
                        <button class="btn btn-view" onclick="viewDetails('${pose.id}')">üëÅÔ∏è View</button>
                        <button class="btn btn-delete" onclick="deletePose('${pose.id}')">üóëÔ∏è Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            renderPagination();
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredPoses.length / itemsPerPage);
            const paginationDiv = document.getElementById('paginationControls');
            paginationDiv.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '‚Üê Previous';
            prevBtn.className = currentPage === 1 ? 'disabled' : '';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => goToPage(currentPage - 1);
            paginationDiv.appendChild(prevBtn);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = currentPage === i ? 'active' : '';
                    pageBtn.onclick = () => goToPage(i);
                    paginationDiv.appendChild(pageBtn);
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    paginationDiv.appendChild(dots);
                }
            }

            // Page info
            const info = document.createElement('span');
            info.className = 'page-info';
            info.textContent = `Page ${currentPage} of ${totalPages}`;
            paginationDiv.appendChild(info);

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next ‚Üí';
            nextBtn.className = currentPage === totalPages ? 'disabled' : '';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => goToPage(currentPage + 1);
            paginationDiv.appendChild(nextBtn);
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredPoses.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderTable();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function viewDetails(poseId) {
            const pose = allPoses.find(p => p.id === poseId);
            if (!pose) return;

            document.getElementById('modalUserName').textContent = pose.user_name;
            document.getElementById('modalUserEmail').textContent = pose.user_email;
            document.getElementById('modalTimestamp').textContent = new Date(pose.timestamp).toLocaleString();
            document.getElementById('modalShoulder').textContent = (pose.shoulder_y_diff || 0).toFixed(2) + ' mm';
            document.getElementById('modalHip').textContent = (pose.hip_y_diff || 0).toFixed(2) + ' mm';
            document.getElementById('modalShoulderSide').textContent = pose.shoulder_higher_side || '-';
            document.getElementById('modalHipSide').textContent = pose.hip_higher_side || '-';
            document.getElementById('modalComment').textContent = pose.admin_comment || 'No comments';

            let status = 'Normal';
            if ((pose.shoulder_y_diff > 10) || (pose.hip_y_diff > 10)) status = 'High Risk';
            else if ((pose.shoulder_y_diff > 5) || (pose.hip_y_diff > 5)) status = 'Moderate';
            document.getElementById('modalStatus').textContent = status;

            const canvas = document.getElementById('poseCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('imageStatus').style.display = 'block';
            document.getElementById('imageStatus').textContent = "Loading Image...";

            if (pose.image_path) {
                img.src = pose.image_path;
                img.onload = () => {
                    document.getElementById('imageStatus').style.display = 'none';
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    drawSkeleton(ctx, pose);
                };
                img.onerror = () => {
                    document.getElementById('imageStatus').textContent = "‚ùå Image not found";
                };
            } else {
                document.getElementById('imageStatus').textContent = "‚ùå No image data";
            }

            document.getElementById('poseModal').style.display = 'block';
        }

        function drawSkeleton(ctx, pose) {
            let landmarksMap = null;

            if (pose.poses && pose.poses.length > 0) {
                if (pose.poses[0].landmarks && !Array.isArray(pose.poses[0].landmarks)) {
                    landmarksMap = pose.poses[0].landmarks;
                }
            }

            if (!landmarksMap) return;

            ctx.lineWidth = 4;
            ctx.strokeStyle = '#00ff00';
            ctx.fillStyle = '#ff0000';

            SKELETON_CONNECTIONS.forEach(([startKey, endKey]) => {
                const start = landmarksMap[startKey];
                const end = landmarksMap[endKey];

                if (start && end && start.likelihood > 0.5 && end.likelihood > 0.5) {
                    ctx.beginPath();
                    ctx.moveTo(start.x, start.y);
                    ctx.lineTo(end.x, end.y);
                    ctx.stroke();
                }
            });

            Object.values(landmarksMap).forEach(point => {
                if (point.likelihood > 0.5) {
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, 6, 0, 2 * Math.PI);
                    ctx.fill();
                }
            });
        }

        function closeModal() {
            document.getElementById('poseModal').style.display = 'none';
        }

        async function deletePose(poseId) {
            if(!confirm('Delete this record?')) return;
            await fetch(`/delete-pose/${poseId}`, { method: 'DELETE' });
            loadData();
        }

        socket.on("call_initiated", (data) => {
            window.location.href = `/admin/video_call/${data.call_id}`;
        });

        window.onload = loadData;
        setInterval(loadData, 30000);
    </script>
</body>
</html>